<!DOCTYPE html>
<html lang="pt-br">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Escola Segura - T√¥NaPorta</title>
    <script src="https://unpkg.com/html5-qrcode"></script>
    <style>
        :root { --primary: #0056b3; --success: #28a745; --bg: #f0f2f5; }
        body { font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Helvetica, Arial, sans-serif; background: var(--bg); margin: 0; padding: 20px; display: flex; flex-direction: column; align-items: center; min-height: 100vh; }
        .screen { display: none; width: 100%; max-width: 400px; background: white; padding: 20px; border-radius: 12px; box-shadow: 0 4px 6px rgba(0,0,0,0.1); box-sizing: border-box; }
        .active { display: block; }
        h1, h2 { text-align: center; color: #333; margin-top: 0; }
        input, select { width: 100%; padding: 12px; margin: 8px 0; border: 1px solid #ddd; border-radius: 8px; box-sizing: border-box; font-size: 16px; }
        button { width: 100%; padding: 14px; margin-top: 10px; border: none; border-radius: 8px; font-size: 16px; font-weight: bold; cursor: pointer; transition: 0.2s; }
        .btn-primary { background: var(--primary); color: white; }
        .btn-success { background: var(--success); color: white; }
        .btn-outline { background: transparent; border: 2px solid var(--primary); color: var(--primary); }
        .btn-back { background: #6c757d; color: white; margin-top: 20px; }
        .student-card { background: #fff; border-left: 5px solid var(--success); padding: 15px; margin-bottom: 10px; border-radius: 4px; box-shadow: 0 2px 4px rgba(0,0,0,0.05); display: flex; justify-content: space-between; align-items: center; }
        #reader { width: 100%; border-radius: 8px; overflow: hidden; margin-top: 10px; }
        .error-msg { color: red; text-align: center; display: none; margin-top: 10px;}
    </style>
</head>
<body>

    <div id="screen-home" class="screen active">
        <h1>üè´ T√¥NaPorta</h1>
        <p style="text-align:center; color:#666;">Selecione seu perfil:</p>
        <button class="btn-primary" onclick="showScreen('screen-parent')">üë®‚Äçüë©‚Äçüëß Sou Respons√°vel</button>
        <button class="btn-outline" onclick="showScreen('screen-teacher')">üë©‚Äçüè´ Sou Escola</button>
    </div>

    <div id="screen-parent" class="screen">
        <h2>Identifica√ß√£o</h2>
        <p style="font-size: 12px; color: #666; text-align:center">Digite o nome conforme cadastro na secretaria.</p>
        <input type="text" id="p_name" placeholder="Nome do Aluno(a)">
        <input type="tel" id="p_pin" placeholder="Sua Senha Pessoal">
        <button class="btn-primary" onclick="startScanner()">üì∏ Abrir C√¢mera</button>
        <button class="btn-back" onclick="showScreen('screen-home')">Voltar</button>
    </div>

    <div id="screen-scan" class="screen">
        <h2>Aponte para o QR Code</h2>
        <div id="reader"></div>
        <p id="loading-msg" style="text-align:center; display:none">Validando senha...</p>
        <button class="btn-back" onclick="stopScanner()">Cancelar</button>
    </div>

    <div id="screen-success" class="screen">
        <h1 style="color:var(--success)">‚úÖ Pronto!</h1>
        <p style="text-align:center;">A professora foi avisada.<br>Aguarde a crian√ßa no port√£o.</p>
        <button class="btn-primary" onclick="location.reload()">In√≠cio</button>
    </div>

    <div id="screen-teacher" class="screen">
        <h2>üì¢ Solicita√ß√µes de Sa√≠da</h2>
        <div id="teacher-list">
            <p style="text-align:center">Carregando...</p>
        </div>
        <button class="btn-back" onclick="showScreen('screen-home')">Sair</button>
    </div>

    <script>
        // --- COLOQUE SUA URL AQUI ---
        const API_URL = 'COLE_SUA_URL_AQUI'; 
        // ----------------------------
        
        const QR_CODE_VALIDO = 'ESCOLA_PORTAO_OFICIAL'; 
        let html5QrCode;

        function showScreen(id) {
            document.querySelectorAll('.screen').forEach(s => s.classList.remove('active'));
            document.getElementById(id).classList.add('active');
            
            if (id === 'screen-teacher') {
                carregarLista();
                window.teacherInterval = setInterval(carregarLista, 5000); 
            } else {
                if (window.teacherInterval) clearInterval(window.teacherInterval);
            }
        }

        function startScanner() {
            const nome = document.getElementById('p_name').value;
            const pin = document.getElementById('p_pin').value;

            if (!nome || !pin) return alert("Preencha nome e senha!");
            
            // N√£o checamos senha aqui mais. Checamos no servidor depois de ler o QR Code.

            showScreen('screen-scan');
            
            html5QrCode = new Html5Qrcode("reader");
            html5QrCode.start(
                { facingMode: "environment" },
                { fps: 10, qrbox: 250 },
                (decodedText) => {
                    if (decodedText === QR_CODE_VALIDO) {
                        html5QrCode.stop();
                        enviarAviso(nome, pin);
                    }
                },
                (errorMessage) => {}
            );
        }

        function stopScanner() {
            if(html5QrCode) html5QrCode.stop();
            showScreen('screen-parent');
        }

        function enviarAviso(nome, senha) {
            document.getElementById('loading-msg').style.display = 'block';
            
            fetch(API_URL, {
                method: 'POST',
                mode: 'no-cors', // Aten√ß√£o: com no-cors n√£o conseguimos ler a resposta de erro
                body: JSON.stringify({ nome: nome, senha: senha })
            }).then(() => {
                // Como usamos no-cors para evitar problemas no Google, assumimos sucesso
                // Se a senha estiver errada, o Google n√£o grava, mas o app vai mostrar Sucesso
                // Para corrigir isso 100%, precisar√≠amos de uma configura√ß√£o mais complexa.
                // NESTA VERS√ÉO SIMPLIFICADA: O app avisa sucesso, mas se a senha estiver errada, o nome N√ÉO aparece na lista da prof.
                showScreen('screen-success');
            }).catch(err => alert("Erro de conex√£o."));
        }

        // --- PROFESSOR ---
        async function carregarLista() {
            try {
                const response = await fetch(API_URL + '?action=read');
                const data = await response.json();
                const lista = document.getElementById('teacher-list');
                lista.innerHTML = '';
                
                if (data.length === 0) {
                    lista.innerHTML = '<p style="text-align:center;color:#999">Nenhum aluno aguardando.</p>';
                    return;
                }

                data.forEach(aluno => {
                    lista.innerHTML += `
                        <div class="student-card">
                            <div class="student-info">
                                <h3>${aluno.nome}</h3>
                                <p>${aluno.turma}</p>
                            </div>
                            <button class="btn-release" onclick="liberarAluno(${aluno.row})">Liberar</button>
                        </div>
                    `;
                });
            } catch (e) { console.error(e); }
        }

        async function liberarAluno(row) {
            if(!confirm("O aluno j√° foi entregue ao respons√°vel?")) return;
            await fetch(API_URL + `?action=complete&row=${row}`);
            carregarLista(); 
        }
    </script>
</body>
</html>
