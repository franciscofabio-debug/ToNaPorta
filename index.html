<!DOCTYPE html>
<html lang="pt-br">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Escola Segura - T√¥NaPorta</title>
    <script src="https://unpkg.com/html5-qrcode"></script>
    <style>
        :root { --primary: #0056b3; --success: #28a745; --bg: #f0f2f5; }
        body { font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Helvetica, Arial, sans-serif; background: var(--bg); margin: 0; padding: 20px; display: flex; flex-direction: column; align-items: center; min-height: 100vh; }
        .screen { display: none; width: 100%; max-width: 400px; background: white; padding: 20px; border-radius: 12px; box-shadow: 0 4px 6px rgba(0,0,0,0.1); box-sizing: border-box; }
        .active { display: block; }
        h1, h2 { text-align: center; color: #333; margin-top: 0; }
        input, select { width: 100%; padding: 12px; margin: 8px 0; border: 1px solid #ddd; border-radius: 8px; box-sizing: border-box; font-size: 16px; }
        button { width: 100%; padding: 14px; margin-top: 10px; border: none; border-radius: 8px; font-size: 16px; font-weight: bold; cursor: pointer; transition: 0.2s; }
        .btn-primary { background: var(--primary); color: white; }
        .btn-outline { background: transparent; border: 2px solid var(--primary); color: var(--primary); }
        .btn-back { background: #6c757d; color: white; margin-top: 20px; }
        .student-card { background: #fff; border-left: 5px solid var(--success); padding: 15px; margin-bottom: 10px; border-radius: 4px; box-shadow: 0 2px 4px rgba(0,0,0,0.05); display: flex; justify-content: space-between; align-items: center; }
        #reader { width: 100%; border-radius: 8px; overflow: hidden; margin-top: 10px; }
        .btn-release { width: auto; padding: 8px 16px; font-size: 14px; background: #dc3545; color: white; }
    </style>
</head>
<body>

    <div id="screen-home" class="screen active">
        <h1>üè´ T√¥NaPorta</h1>
        <p style="text-align:center;">Bem-vindo(a)</p>
        <button class="btn-primary" onclick="showScreen('screen-parent')">üë®‚Äçüë©‚Äçüëß Sou Respons√°vel</button>
        <button class="btn-outline" onclick="showScreen('screen-teacher')">üë©‚Äçüè´ Sou Escola</button>
    </div>

    <div id="screen-parent" class="screen">
        <h2>Identifica√ß√£o</h2>
        <input type="text" id="p_name" placeholder="Nome do Aluno(a)">
        <input type="text" id="p_class" placeholder="Turma (Ex: 1A)">
        <input type="tel" id="p_pin" placeholder="Senha da Escola">
        <button class="btn-primary" onclick="startScanner()">üì∏ Abrir C√¢mera</button>
        <button class="btn-back" onclick="showScreen('screen-home')">Voltar</button>
    </div>

    <div id="screen-scan" class="screen">
        <h2>Aponte para o QR Code</h2>
        <div id="reader"></div>
        <button class="btn-back" onclick="stopScanner()">Cancelar</button>
    </div>

    <div id="screen-success" class="screen">
        <h1 style="color:var(--success)">‚úÖ Sucesso!</h1>
        <p style="text-align:center;">A professora foi avisada.</p>
        <button class="btn-primary" onclick="location.reload()">Novo Aviso</button>
    </div>

    <div id="screen-teacher" class="screen">
        <h2>üì¢ Solicita√ß√µes</h2>
        <div id="teacher-list"><p>Carregando...</p></div>
        <button class="btn-back" onclick="showScreen('screen-home')">Sair</button>
    </div>

    <script>
        // --- SEU ENDERE√áO J√Å EST√Å AQUI ---
        const API_URL = 'https://script.google.com/macros/s/AKfycbxiGBoK7SYyQ887aKY9RqOh18I7NLtSr11jLC9PlleXTmA7zi3AABqNW0KaGAq7GOqS/exec'; 
        // ---------------------------------

        const SENHA_GERAL = '1234'; 
        let html5QrCode;

        function showScreen(id) {
            document.querySelectorAll('.screen').forEach(s => s.classList.remove('active'));
            document.getElementById(id).classList.add('active');
            if (id === 'screen-teacher') {
                carregarLista();
                window.teacherInterval = setInterval(carregarLista, 5000);
            } else {
                if(window.teacherInterval) clearInterval(window.teacherInterval);
            }
        }

        function startScanner() {
            const nome = document.getElementById('p_name').value;
            const turma = document.getElementById('p_class').value;
            const pin = document.getElementById('p_pin').value;

            if (!nome || !turma) return alert("Preencha todos os dados!");
            if (pin !== SENHA_GERAL) return alert("Senha da escola incorreta!");

            showScreen('screen-scan');
            html5QrCode = new Html5Qrcode("reader");
            html5QrCode.start({ facingMode: "environment" }, { fps: 10, qrbox: 250 },
                (decodedText) => {
                    if (decodedText === 'ESCOLA_PORTAO_OFICIAL') {
                        html5QrCode.stop();
                        enviarAviso(nome, turma);
                    }
                }, () => {});
        }

        function stopScanner() {
            if(html5QrCode) html5QrCode.stop();
            showScreen('screen-parent');
        }

        function enviarAviso(nome, turma) {
            fetch(API_URL, {
                method: 'POST', mode: 'no-cors',
                body: JSON.stringify({ nome: nome, turma: turma })
            }).then(() => showScreen('screen-success'))
              .catch(() => alert("Erro ao enviar"));
        }

        async function carregarLista() {
            try {
                const res = await fetch(API_URL + '?action=read');
                const data = await res.json();
                const list = document.getElementById('teacher-list');
                list.innerHTML = '';
                if(data.length === 0) list.innerHTML = '<p style="text-align:center">Fila vazia.</p>';
                data.forEach(aluno => {
                    list.innerHTML += `
                        <div class="student-card">
                            <div><b>${aluno.nome}</b><br><small>${aluno.turma}</small></div>
                            <button class="btn-release" onclick="liberar(${aluno.row})">Liberar</button>
                        </div>`;
                });
            } catch(e) {}
        }

        async function liberar(row) {
            if(!confirm("J√° saiu?")) return;
            await fetch(API_URL + `?action=complete&row=${row}`);
            carregarLista();
        }
    </script>
</body>
</html>
